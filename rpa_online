import pandas as pd
import time
import pyautogui
from PIL import Image, ImageOps
import pytesseract
import os
import sys
import traceback
import pyperclip
import cv2
import numpy
import logging
from logging import StreamHandler

LOG_FILE = "rpa_log.txt"
EXCEL_PATH = r"G:\\python\\saleorder.xlsx"
customer = r"G:\\python\\customer.png"
pyautogui.FAILSAFE = False
TESSERACT_PATH = r"C:\\Program Files\\Tesseract-OCR\\tesseract.exe"
pytesseract.pytesseract.tesseract_cmd = TESSERACT_PATH

def wait_and_click(image, timeout=12, confidence=0.7):
    start = time.time()

    while time.time() - start < timeout:
        try:
            location = pyautogui.locateOnScreen(image, confidence=confidence)
        except:
            location = None

        if location:
            x, y = pyautogui.center(location)
            pyautogui.click(x, y)
            logging.info(f"Clicked: {image}")
            return True

        time.sleep(0.5)

    logging.error(f"Not found: {image}")
    return False


logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s [%(levelname)s] %(message)s',
    handlers=[
        logging.FileHandler(LOG_FILE),
        StreamHandler(sys.stdout)
    ]
)
def process_excel_and_transfer(excel_file):
   

    # Test if image is detected
    # test = pyautogui.locateOnScreen(customer, confidence=0.7)
    # wait_and_click(test)
    # print("DETECTION TEST:", test)
    df = pd.read_excel(EXCEL_PATH)
    for index, row in df.iterrows():
        pyautogui.keyDown('shift')
        pyautogui.keyDown('f3')
        pyautogui.keyUp('f3')
        pyautogui.keyUp('shift')
        time.sleep(1)
        print("Opened Sale Order Filter Screen")
        pyautogui.press('enter')
        time.sleep(1)
        
        name = str(row['name'])
        amount = str(row['amount'])
        time.sleep(1)
        pyautogui.press('ctrl')
        pyautogui.press('down')
        pyautogui.press('down')
        pyautogui.press('down')
        pyautogui.press('down')
        pyautogui.press('down')
        pyautogui.press('down')
        pyautogui.press('enter')
        time.sleep(2)
        pyautogui.write(name)
        print(name)
        pyautogui.press('enter')
        time.sleep(2)
        invoice_region = (1433,331,165,50)
        # x=722 
        # y=500
        # pyautogui.click(x, y, duration=1)
        screenshot = pyautogui.screenshot(region=invoice_region)
        time.sleep(2)
        screenshot.save('invoice.png')
        time.sleep(2)

        custom_config = r'--oem 3 --psm 7 -c tessedit_char_whitelist=0123456789.'
        # img = Image.open('invoice.png').convert('L')
        # img = ImageOps.invert(img).strip()
        # img = img.point(lambda x: 0 if x < 180 else 255)
        text = pytesseract.image_to_string(screenshot, config=custom_config).strip()
        excel_int = int(float(amount))
        detected_int = int(float(text))
        print('Excel amount',excel_int)
        print('Detected amount',excel_int)
        if excel_int != detected_int:
            print("Amount not matched")
        else:
            print("Amount matched")
        pyautogui.press('f7')
        time.sleep(2)
        pyautogui.press('enter')
        time.sleep(2)



if __name__ == "__main__":
    time.sleep(5)
    print("RPA script started...")
    time.sleep(1)
    pyautogui.keyDown('ctrl')
    pyautogui.keyDown('s')
    pyautogui.keyUp('s')
    pyautogui.keyUp('ctrl')
    time.sleep(1)
    print("Opened Sale BIll Screen")
    process_excel_and_transfer(EXCEL_PATH)
    time.sleep(2)
    pyautogui.press('esc')
    logging.info("Process completed successfully.")
    pyautogui.alert('Process completed successfully')

   
